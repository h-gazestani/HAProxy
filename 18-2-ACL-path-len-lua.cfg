-- HAProxy configuration
defaults
    mode http
    timeout client 30s
    timeout connect 10s
    timeout server 30s

frontend myapp_imgeapp
    bind *:80

    use_backend %[lua.choose_backend]

backend my_apps
    server myapp8010 192.168.56.22:8010

backend img_apps
    server myapp8010 192.168.56.22:8030

-- Lua script for dynamic backend selection
core.register_fetches("choose_backend", function(txn)
    local path = txn.sf:path()
    
    if path:sub(1, 4) == "/app" then
        return "my_apps"
    elseif #path == 14 then
        return "img_apps"
    else
        return "my_apps" -- Default backend
    end
end)
